{% extends 'index.html' %}



{% block content-container %}
	{#    {% csrf_token %}#}
	<div id="page-title">
		<h1 class="page-header text-overflow">主机列表</h1>

		<!--Searchbox-->
		<div class="searchbox">
			<div class="input-group custom-search-form">
				<input type="text" class="form-control" placeholder="Search..">
				<span class="input-group-btn">
                    <button class="text-muted" type="button"><i class="pli-magnifi-glass"></i></button>
                </span>
			</div>
		</div>
	</div>
	<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
	<!--End page title-->
	<!--Breadcrumb-->
	<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
	<ol class="breadcrumb">
		<li><a href="#">Home</a></li>
		<li><a href="#">Library</a></li>
		<li class="active">主机列表</li>
	</ol>
	<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
	<!--End breadcrumb-->

	<div id="page-content">

		{% include 'components/hostgroups.html' %}

		<div class="col-lg-9">
			<div class="panel">
				<div class="panel-heading">
					<h3 class="panel-title">命令</h3>
				</div>
				<div class="panel-body">
					<textarea class="form-control" name="" id="cmd"></textarea>
					<button onclick="PostTask('cmd')" class="btn btn-info pull-lg-right">执行</button>
					<button class="btn btn-danger pull-right">终止</button>
				</div>
			</div>

			{% include 'components/task_result.html' %}

		</div>

	</div>
	</div>

	{% include 'components/multitask_js.html' %}

	{#	<script>#}
	{#      function DisplayHostList(self) {#}
	{#          $(self).next().toggleClass("hide");#}
	{#      }#}
	{##}
	{#      function CheckAll(self) {#}
	{#          console.log($(self).prop('checked'));#}
	{#          $(self).parent().find("ul :checkbox").prop('checked', $(self).prop('checked'));#}
	{##}
	{#          ShowCheckedHostCount()#}
	{#      }#}
	{##}
	{#      function ShowCheckedHostCount() {#}
	{#          var selected_host_count = $("#host_groups ul").find(":checked").length;#}
	{#          console.log(selected_host_count);#}
	{#          $("#selected_hosts").text(selected_host_count);#}
	{#          return selected_host_count#}
	{#      }#}
	{##}
	{#      function GetTaskResult(task_id, task_timeout) {#}
	{#          $.getJSON("{% url 'get_task_result' %}", {'task_id': task_id}, function (callback) {#}
	{#              console.log('get task result', callback);#}
	{#              $("#task_result").empty();#}
	{#              var all_task_finished = true;#}
	{#              var finished_task_count = 0;#}
	{#              $.each(callback, function (k, v) {#}
	{#                  var p = document.createElement('p');#}
	{#                  console.log(v.host__host__hostname + '---' + v.host__host__ip_addr + '---' + v.status);#}
	{#                  p.innerText = v.host__host__hostname + '---' + v.host__host__ip_addr + '---' + v.status;#}
	{#                  var pre = document.createElement('pre');#}
	{#                  pre.innerText = v.result;#}
	{#      #}
	{#                  $("#task_result").append(p,pre);#}
	{#                  if(v.status == 3){#}
	{#                      all_task_finished = false;#}
	{#									}else {#}
	{#                      finished_task_count += 1;#}
	{#									}#}
	{#              });//end each#}
	{#							if(task_timeout_count < task_timeout){#}
	{#							    task_timeout_count += 2;#}
	{#							}else {#}
	{#							    all_task_finished = true;#}
	{#							    $.niftyNoty({#}
	{#							        type: 'danger',#}
	{#											container: '#task_result_panel',#}
	{#											html: '<h4 class="alert-title">Task timed out!</h4><p class="alert-message">The task has timed out!</p><div class="mar-top"><button type="button" class="btn btn-info" data-dismiss="noty">Close this notification</button></div>',#}
	{#											closeBtn: false#}
	{#									});#}
	{#							}#}
	{#							if(all_task_finished){#}
	{#							    clearInterval(result_timer);#}
	{#							    console.log('timer canceled...')#}
	{#							}#}
	{#							var total_finished_percent = parseInt(finished_task_count / callback.length * 100);#}
	{#							$("#task_progress").text(total_finished_percent + '%');#}
	{#							$("#task_progress").css("width", total_finished_percent + '%');#}
	{#          });//end getJSON#}
	{#      }#}
	{##}
	{#      function PostTask(type) {#}
	{#          //1. 验证主机列表已选，命令已输入#}
	{#          //2. 提交任务到后台#}
	{#          var host_ids = [];#}
	{#          var selected_host_eles = $("#host_groups ul").find(":checked");#}
	{#          $.each(selected_host_eles, function (k, v) {#}
	{#              host_ids.push($(v).val());#}
	{#          });#}
	{#          console.log('host ids', host_ids);#}
	{#          if (host_ids.length == 0) {#}
	{#              alert("未选择任何主机！");#}
	{#              return false#}
	{#          }#}
	{#          var cmd = $.trim($("#cmd").val());#}
	{#          if (cmd.length == 0) {#}
	{#              alert("未输入命令！");#}
	{#              return false#}
	{#          }#}
	{##}
	{#          var task_data = {#}
	{#              'type': type,#}
	{#              'host_list': host_ids#}
	{#              //'cmd': cmd#}
	{#          };#}
	{##}
	{#          if(type == 'cmd'){#}
	{#              task_data['cmd'] = cmd;#}
	{#					}else {#}
	{#              var file_transfer_type = $("#select[name='transfer-type']").val();#}
	{#              task_data['file_trasfer_type'] = file_transfer_type;#}
	{#              task_data['random_str'] = "{{ random_str }}";#}
	{#              task_data['remote_path'] = $("remote_path").val();#}
	{#					}#}
	{##}
	{#          $.post("{% url 'multitask' %}", {#}
	{#                  'csrfmiddlewaretoken': "{{ csrf_token }}",#}
	{#                  'task_data': JSON.stringify(task_data)#}
	{#              },#}
	{#              function (callback) {#}
	{#                  console.log('post task', callback);#}
	{#                  var callback = JSON.parse(callback);#}
	{#                  GetTaskResult(callback.task_id, callback.timeout);#}
	{#                  task_timeout_count = 0;#}
	{#                  result_timer = setInterval(function () {#}
	{#                      GetTaskResult(callback.task_id, callback.timeout)#}
	{#                  }, 2000)#}
	{#									$("#file-download-btn").removeClass('hide').attr('href',"{% url 'task_file_download' %}?task_id=" + callback.task_id);#}
	{#              })#}
	{#      }#}
	{##}
	{#	</script>#}
{% endblock %}
